{# Linked to from application menu & newtab page. 

Designed (using typography) to make it quick to locate particular dates
and to visually communicate the paths surfers took through this history. #}
<!DOCTYPE html>
{% macro hl-change fmt %}
  {% ifchanged visited_at|date:fmt %}<strong>{{visited_at|date:fmt}}</strong>{% else %}{{visited_at|date:fmt}}{% endif %}
{% endmacro %}
<html>
<head>
  <title>[document-open-recent] {% trans %}History{% endtrans %}</title>
  <style>
    @import url('odysseus:butterick.css');
    input[type=search] {width: 50%;}
  </style>
</head>
{% if url.query.q %}
  {# Load up the full-text search index on-demand #}
  {% query %}INSERT OR IGNORE INTO history_fts(rowid, uri, title)
    SELECT rowid, uri, title FROM page_visit;{% endquery %}
{% endif %}
<body>{% with pagesize=400 q=url.query.q %}
  <nav>
    <aside style="float: right;">
      {% query %}SELECT min(visited_at) AS earliest, max(visited_at) AS latest
        FROM (SELECT visited_at FROM page_visit
          ORDER BY visited_at DESC LIMIT {{pagesize}}
          OFFSET {{url.query.page}}*{{pagesize}});
      {% each-row %}
        {{latest|date}}–{{earliest|date}}
      {% endquery %}
    </aside>
    <form>
      <input type="search" name="q" value="{{q}}" placeholder="{% trans %}History{% endtrans %}" />
    </form>
  </nav>
  <dl>{% query %}SELECT rowid, tab, uri, title, favicon, visited_at, referrer
        FROM page_visit
        WHERE {{q}} = "" OR rowid IN (SELECT rowid FROM history_fts({{q}}))
        ORDER BY visited_at DESC
        LIMIT {{ pagesize }} OFFSET {{ url.query.page|default:0 }}*{{ pagesize }};
  {% each-row %}
    {% ifchanged visited_at|date:"%Y%B%e" %}<dt>
      {% hl-change fmt="%e" %} {% hl-change fmt="%B" %} {% hl-change fmt="%Y" %}
    </dt>{% endif %}
    <dd data-tab="{{tab}}" data-date="{{visited_at}}"
            id="visit-{{rowid}}" {% if referrer %}aria-flowto="visit-{{referrer}}"{% endif %}>
      <em>{% hl-change fmt="%k" %}:{{visited_at|date:"%M"}}</em>
      <a href="{{ uri }}">{{title}}</a>
    </dd>
  {% empty %}
    <dt>{% trans %}Invalid page number!{% endtrans %}</dt>
  {% endquery %}</dl>
  <footer>
    {% query %}SELECT count(*)/{{pagesize}} + 1 AS num_pages FROM page_visit;
    {% each-row %}
      {% for i in num_pages %}
        {% if i != url.query.page %}<a href="odysseus:history?page={{i}}&q={{q}}"{% else %}<strong {% endif %}
          {% query %}SELECT min(visited_at) AS earliest, max(visited_at) AS latest
                FROM (SELECT visited_at FROM page_visit
                  ORDER BY visited_at DESC LIMIT {{pagesize}} OFFSET {{i}}*{{pagesize}});
          {% each-row %}
            title="{{latest|date}}–{{earliest|date}}"
          {% endquery %}
        >●</{% if i != url.query.page %}a{% else %}span{% endif %}>
      {% empty %}
        {% trans %}Wow! No history. <a href="https://alcinnz.github.io/Odysseus-recommendations/">Go explore</a>!{% endtrans %}
      {% endfor %}
    {% endquery %}
  </footer>
</body>
{% endwith %}</html>
